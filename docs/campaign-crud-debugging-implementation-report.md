# μΊ νμΈ CRUD λ””λ²„κΉ… λ° ν•λ“ μ‚­μ  κµ¬ν„ λ³΄κ³ μ„

**μ‘μ„± μΌμ:** 2025-11-20  
**μ‘μ„±μ:** AI Assistant  
**μƒνƒ:** β… κµ¬ν„ μ™„λ£

---

## π“‹ μ”μ•½

μΊ νμΈ μ‚­μ  κΈ°λ¥μ λ¬Έμ μ μ„ ν•΄κ²°ν•κ³ , ν•λ“ μ‚­μ  κΈ°λ¥μ„ κµ¬ν„ν–μµλ‹λ‹¤. μ£Όμ” λ³€κ²½μ‚¬ν•­μ€ λ‹¤μκ³Ό κ°™μµλ‹λ‹¤:

1. **ν¬μΈνΈ νΈλμ­μ… νƒ€μ… ν™•μ¥**: `refund` νƒ€μ… μ¶”κ°€
2. **ν•λ“ μ‚­μ  κµ¬ν„**: μ†ν”„νΈ μ‚­μ μ—μ„ μ‹¤μ  DELETEλ΅ λ³€κ²½
3. **ν¬μΈνΈ ν™λ¶ λ΅μ§**: μΊ νμΈ μ‚­μ  μ‹ μ‚¬μ©λ ν¬μΈνΈ μλ™ ν™λ¶
4. **κ¶ν• μ²΄ν¬ κ°•ν™”**: μƒμ„±ν• λ§¤λ‹μ €λ§ μ‚­μ  κ°€λ¥ν•λ„λ΅ μ ν•
5. **UI κ°μ„ **: μ‚­μ  ν›„ λ©λ΅ μλ™ μƒλ΅κ³ μΉ¨

---

## π” λ¬Έμ  λ¶„μ„

### κΈ°μ΅΄ λ¬Έμ μ 

1. **μ‚­μ  κΈ°λ¥ λ―Έμ‘λ™**
   - μ‚­μ  λ²„νΌ ν΄λ¦­ μ‹ μ„±κ³µ λ©”μ‹μ§€λ§ ν‘μ‹λκ³  μ‹¤μ  μ‚­μ λμ§€ μ•μ
   - μ΅°κ±΄(inactive, μ°Έμ—¬μ 0)μ„ λ§μ΅±ν•΄λ„ μ‚­μ λμ§€ μ•μ

2. **μ†ν”„νΈ μ‚­μ  λ°©μ‹**
   - `status`λ¥Ό `inactive`λ΅ λ³€κ²½ν•λ” λ°©μ‹
   - μ‹¤μ  λ°μ΄ν„°λ” λ‚¨μ•„μμ–΄ λ°μ΄ν„°λ² μ΄μ¤μ— λ¶ν•„μ”ν• λ°μ΄ν„° μ¶•μ 

3. **ν¬μΈνΈ ν™λ¶ λ―Έκµ¬ν„**
   - μΊ νμΈ μƒμ„± μ‹ μ‚¬μ©λ ν¬μΈνΈκ°€ ν™λ¶λμ§€ μ•μ
   - μ‚¬μ©μ κ²½ν— μ €ν•

4. **κ¶ν• μ²΄ν¬ λ¶€μ΅±**
   - λ¨λ“  λ§¤λ‹μ €κ°€ μ‚­μ  κ°€λ¥
   - μΊ νμΈ μƒμ„±μλ§ μ‚­μ  κ°€λ¥ν•΄μ•Ό ν•¨

---

## π› οΈ κµ¬ν„ λ‚΄μ©

### Phase 1: ν¬μΈνΈ νΈλμ­μ… νƒ€μ… ν™•μ¥

**νμΌ:** `supabase/migrations/20251120203000_add_refund_transaction_type.sql`

```sql
-- κΈ°μ΅΄ μ μ•½ μ΅°κ±΄ μ κ±°
ALTER TABLE public.point_transactions
  DROP CONSTRAINT IF EXISTS point_transactions_transaction_type_check;

-- μƒλ΅μ΄ μ μ•½ μ΅°κ±΄ μ¶”κ°€ (refund ν¬ν•¨)
ALTER TABLE public.point_transactions
  ADD CONSTRAINT point_transactions_transaction_type_check 
  CHECK (transaction_type = ANY (ARRAY['earn'::text, 'spend'::text, 'refund'::text]));
```

**λ³€κ²½ μ‚¬ν•­:**
- `point_transactions.transaction_type`μ— `'refund'` νƒ€μ… μ¶”κ°€
- κΈ°μ΅΄ `'earn'`, `'spend'` νƒ€μ…κ³Ό ν•¨κ» μ‚¬μ© κ°€λ¥

---

### Phase 2: μ‚­μ  ν•¨μ μ¬μ‘μ„± (ν•λ“ μ‚­μ  + ν¬μΈνΈ ν™λ¶)

**νμΌ:** `supabase/migrations/20251120203100_improve_delete_campaign_function.sql`

#### μ£Όμ” κΈ°λ¥

1. **κ¶ν• μ²΄ν¬ κ°•ν™”**
   ```sql
   -- ownerμ΄κ±°λ‚, μΊ νμΈμ„ μƒμ„±ν• λ§¤λ‹μ €λ§ μ‚­μ  κ°€λ¥
   IF v_user_role = 'manager' AND v_campaign_user_id != v_user_id THEN
     RAISE EXCEPTION 'μΊ νμΈμ„ μƒμ„±ν• λ§¤λ‹μ €λ§ μ‚­μ ν•  μ μμµλ‹λ‹¤';
   END IF;
   ```

2. **μƒνƒ λ° μ°Έμ—¬μ μ ν™•μΈ**
   ```sql
   -- inactive μƒνƒλ§ μ‚­μ  κ°€λ¥
   IF v_campaign_status != 'inactive' THEN
     RAISE EXCEPTION 'λΉ„ν™μ„±ν™”λ μΊ νμΈλ§ μ‚­μ ν•  μ μμµλ‹λ‹¤';
   END IF;

   -- μ°Έμ—¬μκ°€ μ—†μ–΄μ•Ό μ‚­μ  κ°€λ¥
   IF v_current_participants > 0 THEN
     RAISE EXCEPTION 'μ°Έμ—¬μκ°€ μλ” μΊ νμΈμ€ μ‚­μ ν•  μ μ—†μµλ‹λ‹¤';
   END IF;
   ```

3. **ν¬μΈνΈ ν™λ¶ λ΅μ§**
   ```sql
   -- total_costκ°€ μλ” κ²½μ°λ§ ν™λ¶
   v_refund_amount := COALESCE(v_total_cost, 0);
   
   IF v_refund_amount > 0 THEN
     -- μ§€κ°‘ μ”μ•΅ μ¦κ°€
     UPDATE public.wallets
     SET current_points = current_points + v_refund_amount
     WHERE id = v_wallet_id;

     -- ν¬μΈνΈ νΈλμ­μ… κΈ°λ΅ (refund νƒ€μ…)
     INSERT INTO public.point_transactions (
       wallet_id,
       transaction_type,
       amount,
       campaign_id,
       description,
       created_by_user_id,
       created_at,
       completed_at
     ) VALUES (
       v_wallet_id,
       'refund',
       v_refund_amount,
       p_campaign_id,
       'μΊ νμΈ μ‚­μ  ν™λ¶: ' || v_campaign_title || ' (μΊ νμΈ ID: ' || p_campaign_id::text || ')',
       v_user_id,
       NOW(),
       NOW()
     );
   END IF;
   ```

4. **ν•λ“ μ‚­μ **
   ```sql
   -- μ‹¤μ  DELETE μν–‰
   DELETE FROM public.campaigns
   WHERE id = p_campaign_id;
   ```

#### ν¬μΈνΈ νΈλμ­μ…μ campaign_id μ²λ¦¬

- **μ μ•½ μ΅°κ±΄:** `ON DELETE SET NULL`
- **λ™μ‘:** μΊ νμΈ μ‚­μ  μ‹ `point_transactions.campaign_id`κ°€ μλ™μΌλ΅ NULLλ΅ λ³€κ²½λ¨
- **ν•΄κ²° λ°©μ•:** `description`μ— μΊ νμΈ μ λ©κ³Ό IDλ¥Ό ν¬ν•¨ν•μ—¬ μ¶”μ  κ°€λ¥ν•λ„λ΅ ν•¨

---

### Phase 3: UI κ°μ„ 

**νμΌ:** `lib/screens/mypage/advertiser/advertiser_campaign_detail_screen.dart`

#### λ³€κ²½ μ‚¬ν•­

1. **μ‚­μ  ν›„ λ©λ΅ μƒλ΅κ³ μΉ¨**
   ```dart
   if (result.success) {
     // Provider λ¬΄ν¨ν™”
     ref.invalidate(campaignDetailProvider(widget.campaignId));
     
     // λ³€κ²½μ‚¬ν•­ μμ ν‘μ‹
     setState(() {
       _hasChanges = true;
     });

     // λ©λ΅ ν™”λ©΄μΌλ΅ μ΄λ™ν•λ©΄μ„ μƒλ΅κ³ μΉ¨ νΈλ¦¬κ±°
     context.pop(true); // trueλ¥Ό λ°ν™ν•μ—¬ μƒλ΅κ³ μΉ¨ ν•„μ”ν•¨μ„ μ•λ¦Ό
   }
   ```

2. **ν™λ¶ κΈμ•΅ λ©”μ‹μ§€ ν‘μ‹**
   - ν™λ¶ κΈμ•΅μ΄ μλ” κ²½μ° λ©”μ‹μ§€μ— ν¬ν•¨
   - SnackBar ν‘μ‹ μ‹κ°„ 3μ΄λ΅ μ—°μ¥

**νμΌ:** `lib/screens/mypage/advertiser/advertiser_my_campaigns_screen.dart`

#### κΈ°μ΅΄ κµ¬ν„ ν™•μΈ

- μ΄λ―Έ `pushNamed().then()` ν¨ν„΄ μ‚¬μ© μ¤‘
- `result == true`μΌ λ• `_loadCampaigns()` νΈμ¶
- μ¶”κ°€ μμ • λ¶ν•„μ”

---

## π“ λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§ λ³€κ²½

### 1. ν¬μΈνΈ νΈλμ­μ… νƒ€μ… ν™•μ¥

**ν…μ΄λΈ”:** `point_transactions`

| μ»¬λΌ | νƒ€μ… | μ μ•½ μ΅°κ±΄ | λ³€κ²½ μ‚¬ν•­ |
|------|------|-----------|-----------|
| `transaction_type` | TEXT | CHECK ('earn', 'spend', **'refund'**) | `'refund'` νƒ€μ… μ¶”κ°€ |

### 2. μ‚­μ  ν•¨μ κ°μ„ 

**ν•¨μ:** `delete_campaign(p_campaign_id UUID)`

| κΈ°λ¥ | κΈ°μ΅΄ | λ³€κ²½ ν›„ |
|------|------|---------|
| μ‚­μ  λ°©μ‹ | μ†ν”„νΈ μ‚­μ  (status λ³€κ²½) | ν•λ“ μ‚­μ  (μ‹¤μ  DELETE) |
| ν¬μΈνΈ ν™λ¶ | λ―Έκµ¬ν„ | μλ™ ν™λ¶ |
| κ¶ν• μ²΄ν¬ | λ¨λ“  λ§¤λ‹μ € κ°€λ¥ | μƒμ„±ν• λ§¤λ‹μ €λ§ κ°€λ¥ |
| νΈλμ­μ… κΈ°λ΅ | μ—†μ | `refund` νƒ€μ…μΌλ΅ κΈ°λ΅ |

---

## π§ ν…μ¤νΈ μ‹λ‚λ¦¬μ¤

### μ‹λ‚λ¦¬μ¤ 1: μ •μƒ μ‚­μ  (inactive, μ°Έμ—¬μ 0)

1. **μ „μ  μ΅°κ±΄:**
   - μΊ νμΈ μƒνƒ: `inactive`
   - μ°Έμ—¬μ μ: 0
   - μ‚¬μ©μ: owner λλ” μƒμ„±ν• λ§¤λ‹μ €

2. **μ‹¤ν–‰:**
   - μΊ νμΈ λ””ν…μΌ ν™”λ©΄μ—μ„ "μ‚­μ " λ²„νΌ ν΄λ¦­
   - ν™•μΈ λ‹¤μ΄μ–Όλ΅κ·Έμ—μ„ "μ‚­μ " μ„ νƒ

3. **μμƒ κ²°κ³Ό:**
   - β… μΊ νμΈμ΄ λ°μ΄ν„°λ² μ΄μ¤μ—μ„ μ™„μ „ν μ‚­μ λ¨
   - β… ν¬μΈνΈκ°€ νμ‚¬ μ§€κ°‘μ— ν™λ¶λ¨
   - β… ν¬μΈνΈ νΈλμ­μ…μ— `refund` νƒ€μ…μΌλ΅ κΈ°λ΅λ¨
   - β… λ©λ΅ ν™”λ©΄μΌλ΅ μ΄λ™ν•λ©° μλ™ μƒλ΅κ³ μΉ¨λ¨
   - β… μ‚­μ λ μΊ νμΈμ΄ λ©λ΅μ—μ„ μ κ±°λ¨

### μ‹λ‚λ¦¬μ¤ 2: κ¶ν• μ—†μ (λ‹¤λ¥Έ λ§¤λ‹μ €)

1. **μ „μ  μ΅°κ±΄:**
   - μΊ νμΈ μƒνƒ: `inactive`
   - μ°Έμ—¬μ μ: 0
   - μ‚¬μ©μ: λ‹¤λ¥Έ λ§¤λ‹μ € (μƒμ„±ν•μ§€ μ•μ€ λ§¤λ‹μ €)

2. **μ‹¤ν–‰:**
   - μΊ νμΈ λ””ν…μΌ ν™”λ©΄μ—μ„ "μ‚­μ " λ²„νΌ ν΄λ¦­

3. **μμƒ κ²°κ³Ό:**
   - β "μΊ νμΈμ„ μƒμ„±ν• λ§¤λ‹μ €λ§ μ‚­μ ν•  μ μμµλ‹λ‹¤" μ—λ¬ λ©”μ‹μ§€ ν‘μ‹
   - β… μΊ νμΈμ΄ μ‚­μ λμ§€ μ•μ

### μ‹λ‚λ¦¬μ¤ 3: ν™μ„± μƒνƒ μΊ νμΈ μ‚­μ  μ‹λ„

1. **μ „μ  μ΅°κ±΄:**
   - μΊ νμΈ μƒνƒ: `active`
   - μ°Έμ—¬μ μ: 0

2. **μ‹¤ν–‰:**
   - μΊ νμΈ λ””ν…μΌ ν™”λ©΄μ—μ„ "μ‚­μ " λ²„νΌ ν΄λ¦­

3. **μμƒ κ²°κ³Ό:**
   - β "λΉ„ν™μ„±ν™”λ μΊ νμΈλ§ μ‚­μ ν•  μ μμµλ‹λ‹¤" μ—λ¬ λ©”μ‹μ§€ ν‘μ‹
   - β… μ‚­μ  λ²„νΌμ΄ λΉ„ν™μ„±ν™”λμ–΄ μμ (UIμ—μ„ μ΄λ―Έ μ²λ¦¬)

### μ‹λ‚λ¦¬μ¤ 4: μ°Έμ—¬μκ°€ μλ” μΊ νμΈ μ‚­μ  μ‹λ„

1. **μ „μ  μ΅°κ±΄:**
   - μΊ νμΈ μƒνƒ: `inactive`
   - μ°Έμ—¬μ μ: 1 μ΄μƒ

2. **μ‹¤ν–‰:**
   - μΊ νμΈ λ””ν…μΌ ν™”λ©΄μ—μ„ "μ‚­μ " λ²„νΌ ν΄λ¦­

3. **μμƒ κ²°κ³Ό:**
   - β "μ°Έμ—¬μκ°€ μλ” μΊ νμΈμ€ μ‚­μ ν•  μ μ—†μµλ‹λ‹¤" μ—λ¬ λ©”μ‹μ§€ ν‘μ‹
   - β… μΊ νμΈμ΄ μ‚­μ λμ§€ μ•μ

---

## π“ λ³€κ²½λ νμΌ λ©λ΅

### λ°μ΄ν„°λ² μ΄μ¤ λ§μ΄κ·Έλ μ΄μ…

1. β… `supabase/migrations/20251120203000_add_refund_transaction_type.sql` (μ‹ κ·)
   - ν¬μΈνΈ νΈλμ­μ… νƒ€μ…μ— `refund` μ¶”κ°€

2. β… `supabase/migrations/20251120203100_improve_delete_campaign_function.sql` (μ‹ κ·)
   - `delete_campaign` ν•¨μ μ¬μ‘μ„±
   - ν•λ“ μ‚­μ  + ν¬μΈνΈ ν™λ¶ λ΅μ§ κµ¬ν„

### Flutter ν™”λ©΄

3. β… `lib/screens/mypage/advertiser/advertiser_campaign_detail_screen.dart` (μμ •)
   - μ‚­μ  ν›„ λ©λ΅ μƒλ΅κ³ μΉ¨ λ΅μ§ μ¶”κ°€
   - Provider λ¬΄ν¨ν™” μ¶”κ°€
   - ν™λ¶ λ©”μ‹μ§€ ν‘μ‹ κ°μ„ 

### Flutter μ„λΉ„μ¤

4. β… `lib/services/campaign_service.dart` (ν™•μΈ)
   - `deleteCampaign` λ©”μ„λ“ μ΄λ―Έ κµ¬ν„λμ–΄ μμ
   - μ¶”κ°€ μμ • λ¶ν•„μ”

---

## π” λ³΄μ• κ³ λ ¤μ‚¬ν•­

1. **κ¶ν• μ²΄ν¬**
   - β… RLS μ •μ±…κ³Ό ν•¨μ λ‚΄λ¶€ κ¶ν• μ²΄ν¬ μ΄μ¤‘ κ²€μ¦
   - β… μƒμ„±ν• λ§¤λ‹μ €λ§ μ‚­μ  κ°€λ¥ν•λ„λ΅ μ ν•

2. **λ™μ‹μ„± μ μ–΄**
   - β… `FOR UPDATE`λ¥Ό μ‚¬μ©ν• ν–‰ μ κΈ
   - β… νΈλμ­μ… λ‚΄μ—μ„ μ›μμ  μ²λ¦¬

3. **λ°μ΄ν„° λ¬΄κ²°μ„±**
   - β… μ™Έλ ν‚¤ μ μ•½ μ΅°κ±΄ μ¤€μ
   - β… `ON DELETE SET NULL`λ΅ μΈν• `campaign_id` NULL μ²λ¦¬
   - β… `description`μ— μΊ νμΈ μ •λ³΄ ν¬ν•¨ν•μ—¬ μ¶”μ  κ°€λ¥

---

## β οΈ μ£Όμμ‚¬ν•­

### 1. ν•λ“ μ‚­μ 

- μ‹¤μ  DELETE μν–‰μΌλ΅ λ°μ΄ν„°λ² μ΄μ¤μ—μ„ μ™„μ „ν μ κ±°
- CASCADEλ΅ κ΄€λ ¨ λ°μ΄ν„°λ„ ν•¨κ» μ‚­μ λ¨ (`campaign_action_logs` λ“±)
- **λ³µκµ¬ λ¶κ°€λ¥**ν•λ―€λ΅ μ‹ μ¤‘ν•κ² μ‚¬μ©ν•΄μ•Ό ν•¨

### 2. ν¬μΈνΈ νΈλμ­μ…μ campaign_id

- μΊ νμΈ μ‚­μ  μ‹ `point_transactions.campaign_id`κ°€ μλ™μΌλ΅ NULLλ΅ λ³€κ²½λ¨
- `description`μ— μΊ νμΈ μ •λ³΄κ°€ ν¬ν•¨λμ–΄ μμ–΄ μ¶”μ  κ°€λ¥
- μ§μ ‘ μ΅°μΈμ€ λ¶κ°€λ¥ν•μ§€λ§, `description` νμ‹±μΌλ΅ μ¶”μ  κ°€λ¥

### 3. κ¶ν• μ²΄ν¬

- Ownerλ” λ¨λ“  μΊ νμΈ μ‚­μ  κ°€λ¥
- Managerλ” μμ‹ μ΄ μƒμ„±ν• μΊ νμΈλ§ μ‚­μ  κ°€λ¥
- κ¶ν• μ²΄ν¬λ” ν•¨μ λ‚΄λ¶€μ™€ RLS μ •μ±… λ¨λ‘μ—μ„ μν–‰

---

## π“ μ„±λ¥ μν–¥

### λ°μ΄ν„°λ² μ΄μ¤

- **μ‚­μ  μ„±λ¥:** ν•λ“ μ‚­μ λ΅ μΈν• μΈλ±μ¤ μ—…λ°μ΄νΈ ν•„μ”
- **νΈλμ­μ… κΈ°λ΅:** μ¶”κ°€ INSERT μ‘μ—…μΌλ΅ μΈν• μ•½κ°„μ μ„±λ¥ μ €ν•
- **μ „μ²΄ μν–¥:** λ―Έλ―Έν•¨ (λ‹¨μΌ μΊ νμΈ μ‚­μ )

### μ• ν”λ¦¬μΌ€μ΄μ…

- **UI μ‘λ‹µμ„±:** μ‚­μ  ν›„ λ©λ΅ μƒλ΅κ³ μΉ¨μΌλ΅ μΈν• μ•½κ°„μ μ§€μ—°
- **λ„¤νΈμ›ν¬:** μ¶”κ°€ API νΈμ¶ μ—†μ (κΈ°μ΅΄ RPC νΈμ¶λ§ μ‚¬μ©)

---

## π― ν–¥ν›„ κ°μ„  μ‚¬ν•­

1. **μ‚­μ  λ΅κ·Έ κΈ°λ΅**
   - μΊ νμΈ μ‚­μ  μ΄λ ¥μ„ λ³„λ„ ν…μ΄λΈ”μ— κΈ°λ΅
   - κ°μ‚¬(audit) λ©μ μΌλ΅ ν™μ©

2. **μΌκ΄„ μ‚­μ  κΈ°λ¥**
   - μ—¬λ¬ μΊ νμΈμ„ ν• λ²μ— μ‚­μ ν•λ” κΈ°λ¥
   - κ΄€λ¦¬μμ© κΈ°λ¥μΌλ΅ κµ¬ν„

3. **μ‚­μ  μ „ λ°±μ—…**
   - μ‚­μ  μ „ μΊ νμΈ λ°μ΄ν„°λ¥Ό λ°±μ—… ν…μ΄λΈ”μ— μ €μ¥
   - λ³µκµ¬ κ°€λ¥ν•λ„λ΅ κ°μ„ 

4. **ν¬μΈνΈ νΈλμ­μ… μ΅°ν κ°μ„ **
   - `description` νμ‹± μ—†μ΄ μ΅°ν κ°€λ¥ν•λ„λ΅ κ°μ„ 
   - λ³„λ„ ν•„λ“μ— μΊ νμΈ μ •λ³΄ μ €μ¥ κ³ λ ¤

---

## β… κ²€μ¦ μ™„λ£

- [x] λ§μ΄κ·Έλ μ΄μ… νμΌ μƒμ„± λ° μ μ©
- [x] μ‚­μ  ν•¨μ μ¬μ‘μ„± (ν•λ“ μ‚­μ  + ν¬μΈνΈ ν™λ¶)
- [x] UI κ°μ„  (μ‚­μ  ν›„ λ©λ΅ μƒλ΅κ³ μΉ¨)
- [x] κ¶ν• μ²΄ν¬ κ°•ν™”
- [x] ν¬μΈνΈ νΈλμ­μ… νƒ€μ… ν™•μ¥
- [x] λ¬Έμ„ν™” μ™„λ£

---

**μ‘μ„± μΌμ:** 2025-11-20  
**μ‘μ„±μ:** AI Assistant  
**μƒνƒ:** β… κµ¬ν„ μ™„λ£, ν…μ¤νΈ λ€κΈ°

