# ìº í˜ì¸ ìƒì„± í”„ë¡œì„¸ìŠ¤ ê°œì„  ì‘ì—… ëª©ë¡

**ì‘ì„±ì¼**: 2024ë…„ 12ì›”  
**ë²„ì „**: 1.0  
**ëª©ì **: ìº í˜ì¸ ìƒì„± í”„ë¡œì„¸ìŠ¤ ê°œì„ ì„ ìœ„í•œ ì§„í–‰ ê°€ëŠ¥í•œ ì‘ì—… ëª©ë¡

---

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [ì‘ì—… ëª©ë¡](#ì‘ì—…-ëª©ë¡)
3. [ìƒì„¸ êµ¬í˜„ ê°€ì´ë“œ](#ìƒì„¸-êµ¬í˜„-ê°€ì´ë“œ)
4. [ì°¸ê³ ì‚¬í•­](#ì°¸ê³ ì‚¬í•­)

---

## ê°œìš”

ì´ ë¬¸ì„œëŠ” ìº í˜ì¸ ìƒì„± í”„ë¡œì„¸ìŠ¤ ê°œì„ ì„ ìœ„í•´ ì§„í–‰ ê°€ëŠ¥í•œ ì‘ì—…ë“¤ì„ ì •ë¦¬í•œ ê²ƒì…ë‹ˆë‹¤. ì´ë¯¸ ì™„ë£Œëœ í•­ëª©(ìº í˜ì¸ ìƒì„± í›„ ëª©ë¡ ë°˜ì˜ ë“±)ì€ ì œì™¸í•˜ê³ , ì‹¤ì œë¡œ êµ¬í˜„ì´ í•„ìš”í•œ í•­ëª©ë§Œ í¬í•¨í–ˆìŠµë‹ˆë‹¤.

### ì‘ì—… ìš°ì„ ìˆœìœ„

- **ë†’ìŒ**: ë¡œê·¸ ê´€ë¦¬ ê°œì„ , ì‹ ì²­ ì œí•œ ê¸°ëŠ¥ êµ¬í˜„, ë°ì´í„° ë¬´ê²°ì„± ê°•í™”
- **ì¤‘ê°„**: ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ 
- **ë‚®ìŒ**: ì„±ëŠ¥ ìµœì í™”, ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼

---

## ì‘ì—… ëª©ë¡

### 1. ë¡œê·¸ ê´€ë¦¬ ê°œì„  â­ ìš°ì„ ìˆœìœ„: ë†’ìŒ

#### 1.1 `campaign_logs` í…Œì´ë¸” ìƒì„±

**ëª©ì **: ìº í˜ì¸ ìƒì„±, ìˆ˜ì •, ì‚­ì œ ë“±ì˜ ëª¨ë“  ì•¡ì…˜ì„ ì¶”ì í•˜ê¸° ìœ„í•œ ë¡œê·¸ í…Œì´ë¸”

**ì‘ì—… ë‚´ìš©**:
- [ ] `campaign_logs` í…Œì´ë¸” ìƒì„± (ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼)
- [ ] ì¸ë±ìŠ¤ ìƒì„±
- [ ] RLS ì •ì±… ì„¤ì •
- [ ] í…Œì´ë¸” ì½”ë©˜íŠ¸ ì¶”ê°€

**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 1-2ì‹œê°„

#### 1.2 RPC í•¨ìˆ˜ì— ë¡œê·¸ ê¸°ë¡ ë¡œì§ ì¶”ê°€

**ëª©ì **: ìº í˜ì¸ ìƒì„± ì„±ê³µ/ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ ë¡œê·¸ ê¸°ë¡

**ì‘ì—… ë‚´ìš©**:
- [ ] `create_campaign_with_points_v2` í•¨ìˆ˜ì— ì„±ê³µ ë¡œê·¸ ê¸°ë¡ ì¶”ê°€
- [ ] `create_campaign_with_points_v2` í•¨ìˆ˜ì— ì‹¤íŒ¨ ë¡œê·¸ ê¸°ë¡ ì¶”ê°€ (EXCEPTION í•¸ë“¤ëŸ¬)

**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 1-2ì‹œê°„

#### 1.3 ìƒì„± ì‹¤íŒ¨ ì‹œ ìƒì„¸ ì—ëŸ¬ ë¡œê·¸ ê¸°ë¡

**ëª©ì **: ìº í˜ì¸ ìƒì„± ì‹¤íŒ¨ ì›ì¸ì„ ì¶”ì í•˜ê¸° ìœ„í•œ ìƒì„¸ ë¡œê·¸

**ì‘ì—… ë‚´ìš©**:
- [ ] ì—ëŸ¬ ë©”ì‹œì§€ ê¸°ë¡
- [ ] ì‹¤íŒ¨ ì‹œì ì˜ ìƒíƒœ ì •ë³´ ê¸°ë¡
- [ ] í¬ì¸íŠ¸ ì”ì•¡ ì •ë³´ ê¸°ë¡ (ì‹¤íŒ¨ ì‹œì—ë„)

**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 1ì‹œê°„

---

### 2. ì‹ ì²­ ì œí•œ ê¸°ëŠ¥ êµ¬í˜„ â­ ìš°ì„ ìˆœìœ„: ë†’ìŒ

#### 2.1 ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë³€ê²½

**ëª©ì **: ë¦¬ë·°ì–´ë‹¹ ì‹ ì²­ ê°€ëŠ¥ ê°œìˆ˜ë¥¼ ì €ì¥í•  ì»¬ëŸ¼ ì¶”ê°€

**ì‘ì—… ë‚´ìš©**:
- [ ] `campaigns` í…Œì´ë¸”ì— `max_per_reviewer` ì»¬ëŸ¼ ì¶”ê°€ (INTEGER, DEFAULT 1, NOT NULL)
- [ ] ì œì•½ ì¡°ê±´ ì¶”ê°€: `max_per_reviewer >= 1`
- [ ] ì»¬ëŸ¼ ì½”ë©˜íŠ¸ ì¶”ê°€

**ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜ˆì‹œ**:
```sql
ALTER TABLE public.campaigns 
ADD COLUMN IF NOT EXISTS max_per_reviewer INTEGER DEFAULT 1 NOT NULL;

ALTER TABLE public.campaigns
ADD CONSTRAINT campaigns_max_per_reviewer_check 
CHECK (max_per_reviewer >= 1);

COMMENT ON COLUMN public.campaigns.max_per_reviewer IS 
'ë¦¬ë·°ì–´ë‹¹ ì‹ ì²­ ê°€ëŠ¥ ê°œìˆ˜ (í•œ ë¦¬ë·°ì–´ê°€ í•´ë‹¹ ìº í˜ì¸ì— ì‹ ì²­í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ íšŸìˆ˜)';
```

**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 30ë¶„

#### 2.2 RPC í•¨ìˆ˜ ìˆ˜ì •

**ëª©ì **: ìº í˜ì¸ ìƒì„± ì‹œ `max_per_reviewer` ê°’ì„ ë°›ì•„ì„œ ì €ì¥

**ì‘ì—… ë‚´ìš©**:
- [ ] `create_campaign_with_points_v2` í•¨ìˆ˜ì— `p_max_per_reviewer` íŒŒë¼ë¯¸í„° ì¶”ê°€
- [ ] INSERT ë¬¸ì— `max_per_reviewer` ì»¬ëŸ¼ ì¶”ê°€
- [ ] ê¸°ë³¸ê°’ ì²˜ë¦¬ (NULLì¸ ê²½ìš° 1ë¡œ ì„¤ì •)

**íŒŒë¼ë¯¸í„° ì¶”ê°€ ì˜ˆì‹œ**:
```sql
CREATE OR REPLACE FUNCTION "public"."create_campaign_with_points_v2"(
    -- ... ê¸°ì¡´ íŒŒë¼ë¯¸í„°ë“¤ ...
    "p_max_per_reviewer" integer DEFAULT 1
) RETURNS "jsonb"
```

**INSERT ìˆ˜ì • ì˜ˆì‹œ**:
```sql
INSERT INTO public.campaigns (
    -- ... ê¸°ì¡´ ì»¬ëŸ¼ë“¤ ...
    max_per_reviewer,
    -- ... ê¸°íƒ€ ì»¬ëŸ¼ë“¤ ...
) VALUES (
    -- ... ê¸°ì¡´ ê°’ë“¤ ...
    COALESCE(p_max_per_reviewer, 1),
    -- ... ê¸°íƒ€ ê°’ë“¤ ...
);
```

**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 1ì‹œê°„

#### 2.3 Flutter ì„œë¹„ìŠ¤ ë ˆì´ì–´ ìˆ˜ì •

**ëª©ì **: RPC í•¨ìˆ˜ í˜¸ì¶œ ì‹œ `max_per_reviewer` íŒŒë¼ë¯¸í„° ì „ë‹¬

**ì‘ì—… ë‚´ìš©**:
- [ ] `lib/services/campaign_service.dart`ì˜ `createCampaignV2` ë©”ì„œë“œì— `maxPerReviewer` íŒŒë¼ë¯¸í„° ì¶”ê°€
- [ ] RPC í˜¸ì¶œ ì‹œ `p_max_per_reviewer` íŒŒë¼ë¯¸í„° ì¶”ê°€

**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 30ë¶„

#### 2.4 Flutter UI ìˆ˜ì •

**ëª©ì **: ì‚¬ìš©ìê°€ ë¦¬ë·°ì–´ë‹¹ ì‹ ì²­ ê°€ëŠ¥ ê°œìˆ˜ë¥¼ ì…ë ¥í•  ìˆ˜ ìˆë„ë¡ UI ì¶”ê°€

**ì‘ì—… ë‚´ìš©**:
- [ ] `lib/screens/campaign/campaign_creation_screen.dart`ì— ì…ë ¥ í•„ë“œ ì¶”ê°€
- [ ] ê¸°ë³¸ê°’ 1ë¡œ ì„¤ì •
- [ ] ìœ íš¨ì„± ê²€ì¦ ì¶”ê°€ (1 ì´ìƒ)
- [ ] ë¹„ìš© ê³„ì‚°ì— ì˜í–¥ ì—†ìŒ (ì°¸ê³ ìš©)

**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 1-2ì‹œê°„

#### 2.5 ìº í˜ì¸ ì‹ ì²­ ë¡œì§ êµ¬í˜„

**ëª©ì **: ìº í˜ì¸ ì‹ ì²­ ì‹œ `max_per_reviewer` ì œí•œ í™•ì¸

**ì‘ì—… ë‚´ìš©**:
- [ ] ìº í˜ì¸ ì‹ ì²­ RPC í•¨ìˆ˜ì—ì„œ `max_per_reviewer` í™•ì¸ ë¡œì§ ì¶”ê°€
- [ ] í˜„ì¬ ì‹ ì²­ íšŸìˆ˜ ì¡°íšŒ
- [ ] ì œí•œ ì´ˆê³¼ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ ë°˜í™˜
- [ ] ì—ëŸ¬ ë©”ì‹œì§€: "ì´ ìº í˜ì¸ì—ëŠ” ìµœëŒ€ NíšŒê¹Œì§€ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."

**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 2-3ì‹œê°„

---

### 3. ë°ì´í„° ë¬´ê²°ì„± ê°•í™” â­ ìš°ì„ ìˆœìœ„: ë†’ìŒ

#### 3.1 ì œì•½ ì¡°ê±´ ì¶”ê°€

**ëª©ì **: ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥

**ì‘ì—… ë‚´ìš©**:
- [ ] `max_per_reviewer >= 1` ì œì•½ ì¡°ê±´ ì¶”ê°€ (2.1ì—ì„œ í•¨ê»˜ ì§„í–‰)
- [ ] ê¸°ì¡´ ë°ì´í„° ê²€ì¦ (ê¸°ì¡´ ìº í˜ì¸ì˜ `max_per_reviewer`ê°€ NULLì´ê±°ë‚˜ 0ì¸ ê²½ìš° ì—…ë°ì´íŠ¸)

**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 30ë¶„

---

### 4. ì—ëŸ¬ ì²˜ë¦¬ ê°œì„  âš ï¸ ìš°ì„ ìˆœìœ„: ì¤‘ê°„

#### 4.1 êµ¬ì²´ì ì¸ ì—ëŸ¬ ì½”ë“œ ì •ì˜

**ëª©ì **: ì—ëŸ¬ íƒ€ì…ë³„ë¡œ êµ¬ì²´ì ì¸ ì½”ë“œë¥¼ ì •ì˜í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì²˜ë¦¬ ê°€ëŠ¥í•˜ë„ë¡

**ì‘ì—… ë‚´ìš©**:
- [ ] ì—ëŸ¬ ì½”ë“œ ì²´ê³„ ì •ì˜
  - `UNAUTHORIZED`: ì¸ì¦ ì‹¤íŒ¨
  - `NO_COMPANY`: íšŒì‚¬ ì†Œì† ì—†ìŒ
  - `NO_WALLET`: ì§€ê°‘ ì—†ìŒ
  - `INSUFFICIENT_POINTS`: í¬ì¸íŠ¸ ë¶€ì¡±
  - `POINT_DEDUCTION_FAILED`: í¬ì¸íŠ¸ ì°¨ê° ì‹¤íŒ¨
  - `INVALID_PARAMETERS`: ì˜ëª»ëœ íŒŒë¼ë¯¸í„°
- [ ] RPC í•¨ìˆ˜ì—ì„œ ì—ëŸ¬ ì½”ë“œ ë°˜í™˜í•˜ë„ë¡ ìˆ˜ì •

**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 2-3ì‹œê°„

#### 4.2 ì—ëŸ¬ ë©”ì‹œì§€ ì‚¬ìš©ì ì¹œí™”ì  ê°œì„ 

**ëª©ì **: ì‚¬ìš©ìê°€ ì´í•´í•˜ê¸° ì‰¬ìš´ ì—ëŸ¬ ë©”ì‹œì§€ ì œê³µ

**ì‘ì—… ë‚´ìš©**:
- [ ] ê¸°ìˆ ì  ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€ë¡œ ë³€í™˜
- [ ] Flutterì—ì„œ ì—ëŸ¬ ì½”ë“œì— ë”°ë¼ ì ì ˆí•œ ë©”ì‹œì§€ í‘œì‹œ
- [ ] ë‹¤êµ­ì–´ ì§€ì› ê³ ë ¤ (ì„ íƒ)

**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 1-2ì‹œê°„

---

### 5. ì„ íƒì  ê°œì„ ì‚¬í•­ (ìš°ì„ ìˆœìœ„: ë‚®ìŒ)

#### 5.1 ë¡œê·¸ ì¡°íšŒ API ì¶”ê°€

**ëª©ì **: ê´€ë¦¬ìê°€ ìº í˜ì¸ ìƒì„± ë¡œê·¸ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆë„ë¡

**ì‘ì—… ë‚´ìš©**:
- [ ] RPC í•¨ìˆ˜ `get_campaign_logs_safe` ìƒì„±
- [ ] íšŒì‚¬ë³„, ì‚¬ìš©ìë³„, ìº í˜ì¸ë³„ í•„í„°ë§ ì§€ì›
- [ ] í˜ì´ì§€ë„¤ì´ì…˜ ì§€ì›

**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 2-3ì‹œê°„

#### 5.2 ë¡œê·¸ ë¶„ì„ ëŒ€ì‹œë³´ë“œ

**ëª©ì **: ìº í˜ì¸ ìƒì„± í†µê³„ ë° ë¶„ì„

**ì‘ì—… ë‚´ìš©**:
- [ ] ì¼ë³„/ì›”ë³„ ìƒì„± í†µê³„
- [ ] ìƒì„± ì‹¤íŒ¨ìœ¨ ë¶„ì„
- [ ] ìƒì„± ì†Œìš” ì‹œê°„ ì¶”ì 

**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 4-6ì‹œê°„

---

## ìƒì„¸ êµ¬í˜„ ê°€ì´ë“œ

### 1. `campaign_logs` í…Œì´ë¸” ìƒì„±

#### í…Œì´ë¸” êµ¬ì¡°

```sql
CREATE TABLE IF NOT EXISTS public.campaign_logs (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    campaign_id UUID,  -- NULL ê°€ëŠ¥ (ìƒì„± ì‹¤íŒ¨ ì‹œ)
    company_id UUID NOT NULL,
    user_id UUID NOT NULL,  -- ìƒì„±ì
    
    -- ë¡œê·¸ íƒ€ì…
    log_type TEXT NOT NULL,  -- 'creation', 'update', 'status_change', 'deletion'
    action TEXT NOT NULL,  -- 'create', 'update', 'activate', 'deactivate', 'delete'
    
    -- ì´ì „/ì´í›„ ê°’ (JSONB)
    previous_data JSONB,  -- ë³€ê²½ ì „ ë°ì´í„°
    new_data JSONB,  -- ë³€ê²½ í›„ ë°ì´í„°
    
    -- ê²°ê³¼
    status TEXT NOT NULL,  -- 'success', 'failed', 'pending'
    error_message TEXT,  -- ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€
    
    -- ë©”íƒ€ë°ì´í„°
    ip_address TEXT,
    user_agent TEXT,
    request_id UUID,  -- ìš”ì²­ ì¶”ì ìš©
    
    -- ë¹„ìš© ì •ë³´
    points_spent INTEGER,
    points_before INTEGER,
    points_after INTEGER,
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    
    -- ì œì•½ ì¡°ê±´
    CONSTRAINT campaign_logs_log_type_check CHECK (
        log_type IN ('creation', 'update', 'status_change', 'deletion')
    ),
    CONSTRAINT campaign_logs_action_check CHECK (
        action IN ('create', 'update', 'activate', 'deactivate', 'delete', 'cancel')
    ),
    CONSTRAINT campaign_logs_status_check CHECK (
        status IN ('success', 'failed', 'pending')
    ),
    
    -- ì™¸ë˜ í‚¤
    FOREIGN KEY (campaign_id) REFERENCES campaigns(id) ON DELETE SET NULL,
    FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### ì¸ë±ìŠ¤

```sql
-- ë¹ ë¥¸ ì¡°íšŒë¥¼ ìœ„í•œ ì¸ë±ìŠ¤
CREATE INDEX idx_campaign_logs_campaign_id ON campaign_logs(campaign_id);
CREATE INDEX idx_campaign_logs_company_id ON campaign_logs(company_id);
CREATE INDEX idx_campaign_logs_user_id ON campaign_logs(user_id);
CREATE INDEX idx_campaign_logs_log_type ON campaign_logs(log_type);
CREATE INDEX idx_campaign_logs_status ON campaign_logs(status);
CREATE INDEX idx_campaign_logs_created_at ON campaign_logs(created_at DESC);
CREATE INDEX idx_campaign_logs_company_created ON campaign_logs(company_id, created_at DESC);
```

#### RLS ì •ì±…

```sql
-- RLS í™œì„±í™”
ALTER TABLE campaign_logs ENABLE ROW LEVEL SECURITY;

-- íšŒì‚¬ ë©¤ë²„ëŠ” ìì‹ ì˜ íšŒì‚¬ ë¡œê·¸ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Company members can view their company campaign logs"
ON campaign_logs FOR SELECT
USING (
    company_id IN (
        SELECT company_id FROM company_users
        WHERE user_id = auth.uid() AND status = 'active'
    )
);

-- ì‹œìŠ¤í…œë§Œ INSERT ê°€ëŠ¥ (RPC í•¨ìˆ˜ì—ì„œ)
CREATE POLICY "System can insert campaign logs"
ON campaign_logs FOR INSERT
WITH CHECK (true);  -- RPC í•¨ìˆ˜ì—ì„œë§Œ ì‚¬ìš©
```

#### RPC í•¨ìˆ˜ ìˆ˜ì • ì˜ˆì‹œ

```sql
-- ìº í˜ì¸ ìƒì„± ì„±ê³µ í›„ ë¡œê·¸ ê¸°ë¡
INSERT INTO public.campaign_logs (
    campaign_id, company_id, user_id,
    log_type, action, status,
    new_data, points_spent, points_before, points_after,
    created_at
) VALUES (
    v_campaign_id, v_company_id, v_user_id,
    'creation', 'create', 'success',
    jsonb_build_object(
        'title', p_title,
        'campaign_type', p_campaign_type,
        'total_cost', v_total_cost,
        'max_participants', p_max_participants,
        'max_per_reviewer', COALESCE(p_max_per_reviewer, 1)
    ),
    v_total_cost, v_points_before_deduction, v_points_after_deduction,
    NOW()
);

-- ì‹¤íŒ¨ ì‹œì—ë„ ë¡œê·¸ ê¸°ë¡
EXCEPTION
    WHEN OTHERS THEN
        INSERT INTO public.campaign_logs (
            company_id, user_id,
            log_type, action, status,
            error_message, points_spent, points_before,
            created_at
        ) VALUES (
            v_company_id, v_user_id,
            'creation', 'create', 'failed',
            SQLERRM, v_total_cost, v_points_before_deduction,
            NOW()
        );
        RETURN jsonb_build_object('success', false, 'error', SQLERRM);
```

### 2. `max_per_reviewer` ê¸°ëŠ¥ êµ¬í˜„

#### ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ì˜ˆì‹œ

```sql
-- campaigns í…Œì´ë¸”ì— max_per_reviewer ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE public.campaigns 
ADD COLUMN IF NOT EXISTS max_per_reviewer INTEGER DEFAULT 1 NOT NULL;

-- ì œì•½ ì¡°ê±´ ì¶”ê°€
ALTER TABLE public.campaigns
ADD CONSTRAINT campaigns_max_per_reviewer_check 
CHECK (max_per_reviewer >= 1);

-- ì»¬ëŸ¼ ì½”ë©˜íŠ¸ ì¶”ê°€
COMMENT ON COLUMN public.campaigns.max_per_reviewer IS 
'ë¦¬ë·°ì–´ë‹¹ ì‹ ì²­ ê°€ëŠ¥ ê°œìˆ˜ (í•œ ë¦¬ë·°ì–´ê°€ í•´ë‹¹ ìº í˜ì¸ì— ì‹ ì²­í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ íšŸìˆ˜)';

-- ê¸°ì¡´ ë°ì´í„° ì—…ë°ì´íŠ¸ (NULL ë˜ëŠ” 0ì¸ ê²½ìš°)
UPDATE public.campaigns 
SET max_per_reviewer = 1 
WHERE max_per_reviewer IS NULL OR max_per_reviewer < 1;
```

#### RPC í•¨ìˆ˜ íŒŒë¼ë¯¸í„° ì¶”ê°€

```sql
CREATE OR REPLACE FUNCTION "public"."create_campaign_with_points_v2"(
    "p_title" "text",
    "p_description" "text",
    "p_campaign_type" "text",
    "p_campaign_reward" integer,
    "p_max_participants" integer,
    "p_start_date" timestamp with time zone,
    "p_end_date" timestamp with time zone,
    "p_platform" "text" DEFAULT NULL::"text",
    "p_keyword" "text" DEFAULT NULL::"text",
    "p_option" "text" DEFAULT NULL::"text",
    "p_quantity" integer DEFAULT 1,
    "p_seller" "text" DEFAULT NULL::"text",
    "p_product_number" "text" DEFAULT NULL::"text",
    "p_product_image_url" "text" DEFAULT NULL::"text",
    "p_product_name" "text" DEFAULT NULL::"text",
    "p_product_price" integer DEFAULT NULL::integer,
    "p_purchase_method" "text" DEFAULT 'mobile'::"text",
    "p_product_description" "text" DEFAULT NULL::"text",
    "p_review_type" "text" DEFAULT 'star_only'::"text",
    "p_review_text_length" integer DEFAULT NULL::integer,
    "p_review_image_count" integer DEFAULT NULL::integer,
    "p_prevent_product_duplicate" boolean DEFAULT false,
    "p_prevent_store_duplicate" boolean DEFAULT false,
    "p_duplicate_prevent_days" integer DEFAULT 0,
    "p_payment_method" "text" DEFAULT 'platform'::"text",
    "p_expiration_date" timestamp with time zone DEFAULT NULL::timestamp with time zone,
    "p_max_per_reviewer" integer DEFAULT 1  -- âœ… ì¶”ê°€
) RETURNS "jsonb"
```

#### INSERT ë¬¸ ìˆ˜ì •

```sql
INSERT INTO public.campaigns (
    title, description, company_id, user_id,
    campaign_type, platform,
    keyword, option, quantity, seller, product_number,
    product_image_url, product_name, product_price,
    purchase_method,
    review_type, review_text_length, review_image_count,
    campaign_reward, max_participants, current_participants,
    max_per_reviewer,  -- âœ… ì¶”ê°€
    start_date, end_date, expiration_date,
    prevent_product_duplicate, prevent_store_duplicate, duplicate_prevent_days,
    payment_method, total_cost,
    status, created_at, updated_at
) VALUES (
    p_title, p_description, v_company_id, v_user_id,
    p_campaign_type, p_platform,
    p_keyword, p_option, p_quantity, p_seller, p_product_number,
    p_product_image_url, p_product_name, p_product_price,
    p_purchase_method,
    p_review_type, p_review_text_length, p_review_image_count,
    p_campaign_reward, p_max_participants, 0,
    COALESCE(p_max_per_reviewer, 1),  -- âœ… ì¶”ê°€ (ê¸°ë³¸ê°’: 1)
    p_start_date, p_end_date, 
    COALESCE(p_expiration_date, p_end_date + INTERVAL '30 days'),
    p_prevent_product_duplicate, p_prevent_store_duplicate, p_duplicate_prevent_days,
    p_payment_method, v_total_cost,
    'active', NOW(), NOW()
) RETURNING id INTO v_campaign_id;
```

#### Flutter ì„œë¹„ìŠ¤ ìˆ˜ì • ì˜ˆì‹œ

```dart
// lib/services/campaign_service.dart
Future<ApiResponse<Campaign>> createCampaignV2({
  required String title,
  required String description,
  required String campaignType,
  required String platform,
  required int campaignReward,
  required int maxParticipants,
  required int maxPerReviewer,  // âœ… ì¶”ê°€
  required DateTime startDate,
  required DateTime endDate,
  required DateTime expirationDate,
  // ... ê¸°íƒ€ íŒŒë¼ë¯¸í„°
}) async {
  // ...
  final response = await _supabase.rpc(
    'create_campaign_with_points_v2',
    params: {
      // ... ê¸°ì¡´ íŒŒë¼ë¯¸í„°ë“¤ ...
      'p_max_per_reviewer': maxPerReviewer,  // âœ… ì¶”ê°€
    },
  );
  // ...
}
```

#### Flutter UI ìˆ˜ì • ì˜ˆì‹œ

```dart
// lib/screens/campaign/campaign_creation_screen.dart
final _maxPerReviewerController = TextEditingController(text: '1');

// ìœ íš¨ì„± ê²€ì¦
String? _validateMaxPerReviewer(String? value) {
  if (value == null || value.isEmpty) {
    return 'ë¦¬ë·°ì–´ë‹¹ ì‹ ì²­ ê°€ëŠ¥ ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
  }
  final count = int.tryParse(value);
  if (count == null || count < 1) {
    return '1 ì´ìƒì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
  }
  return null;
}

// UI ìœ„ì ¯
TextFormField(
  controller: _maxPerReviewerController,
  decoration: InputDecoration(
    labelText: 'ë¦¬ë·°ì–´ë‹¹ ì‹ ì²­ ê°€ëŠ¥ ê°œìˆ˜',
    hintText: '1',
    helperText: 'í•œ ë¦¬ë·°ì–´ê°€ ì´ ìº í˜ì¸ì— ì‹ ì²­í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ íšŸìˆ˜',
  ),
  keyboardType: TextInputType.number,
  validator: _validateMaxPerReviewer,
)
```

---

## ì°¸ê³ ì‚¬í•­

### ì´ë¯¸ ì™„ë£Œëœ í•­ëª©

ë‹¤ìŒ í•­ëª©ë“¤ì€ ì´ë¯¸ êµ¬í˜„ë˜ì–´ ìˆì–´ ì´ ë¬¸ì„œì— í¬í•¨í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:

1. **ìº í˜ì¸ ìƒì„± í›„ ëª©ë¡ ë°˜ì˜ ë¬¸ì œ**
   - `advertiser_my_campaigns_screen.dart`ì—ì„œ Campaign ê°ì²´ë¥¼ ì§ì ‘ ë°›ì•„ ì¶”ê°€í•˜ëŠ” ë¡œì§ êµ¬í˜„ë¨
   - í´ë§ fallbackë„ êµ¬í˜„ë¨

### ì‘ì—… ìˆœì„œ ê¶Œì¥ì‚¬í•­

1. **1ë‹¨ê³„**: `campaign_logs` í…Œì´ë¸” ìƒì„± ë° RPC í•¨ìˆ˜ ìˆ˜ì •
   - ë¡œê·¸ ê¸°ë¡ ì¸í”„ë¼ë¥¼ ë¨¼ì € êµ¬ì¶•í•˜ì—¬ ì´í›„ ì‘ì—… ì¶”ì  ê°€ëŠ¥

2. **2ë‹¨ê³„**: `max_per_reviewer` ê¸°ëŠ¥ êµ¬í˜„
   - ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë³€ê²½ â†’ RPC í•¨ìˆ˜ ìˆ˜ì • â†’ Flutter ì„œë¹„ìŠ¤ ìˆ˜ì • â†’ UI ìˆ˜ì • â†’ ì‹ ì²­ ë¡œì§ êµ¬í˜„ ìˆœì„œë¡œ ì§„í–‰

3. **3ë‹¨ê³„**: ì—ëŸ¬ ì²˜ë¦¬ ê°œì„  (ì„ íƒ)
   - ë¡œê·¸ ì‹œìŠ¤í…œì´ êµ¬ì¶•ëœ í›„ ì—ëŸ¬ ì¶”ì ì´ ìš©ì´í•´ì§

### ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ëª…ëª… ê·œì¹™

ìƒˆ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì€ ë‹¤ìŒ í˜•ì‹ì„ ë”°ë¦…ë‹ˆë‹¤:
```
supabase/migrations/YYYYMMDDHHMMSS_description.sql
```

ì˜ˆì‹œ:
- `20241225120000_add_campaign_logs_table.sql`
- `20241225120100_add_max_per_reviewer_to_campaigns.sql`
- `20241225120200_update_create_campaign_rpc_with_logging.sql`

### í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

ê° ì‘ì—… ì™„ë£Œ í›„ ë‹¤ìŒì„ í…ŒìŠ¤íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤:

- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì´ ì •ìƒì ìœ¼ë¡œ ì ìš©ë˜ëŠ”ì§€ í™•ì¸
- [ ] RPC í•¨ìˆ˜ê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸
- [ ] Flutter ì•±ì—ì„œ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸
- [ ] ì—ëŸ¬ ì¼€ì´ìŠ¤ ì²˜ë¦¬ í™•ì¸
- [ ] RLS ì •ì±…ì´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸

---

**ë¬¸ì„œ ì‘ì„±ì**: AI Assistant  
**ìµœì¢… ìˆ˜ì •ì¼**: 2024ë…„ 12ì›”  
**ë‹¤ìŒ ê²€í†  ì˜ˆì •ì¼**: ì‘ì—… ì™„ë£Œ í›„

