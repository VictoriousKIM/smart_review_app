<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R2 ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            margin: 20px 0;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #666;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        #selectedFile {
            margin: 10px 0;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>R2 ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</h1>
    <p>ì‚¬ì—…ìë“±ë¡ì¦(í¬ì¸í„°ìŠ¤) (1).png íŒŒì¼ì„ ì„ íƒí•˜ê³  ì—…ë¡œë“œ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
    
    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <p>ğŸ“ íŒŒì¼ì„ í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒ</p>
        <input type="file" id="fileInput" style="display: none;" accept=".png,.jpg,.jpeg,.pdf">
    </div>
    
    <div id="selectedFile"></div>
    
    <button id="uploadBtn" onclick="uploadFile()" disabled>ì—…ë¡œë“œ</button>
    
    <div id="result"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        const supabaseUrl = 'http://127.0.0.1:54321';
        const supabaseKey = 'sb_publishable_ACJWlzQHlZjBrEguHvfOxg_3BJgxAaH';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('selectedFile').innerHTML = 
                    `<strong>ì„ íƒëœ íŒŒì¼:</strong> ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                document.getElementById('uploadBtn').disabled = false;
            }
        });

        window.uploadFile = async function() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            const result = document.getElementById('result');
            
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...';
            result.style.display = 'none';

            try {
                // 1. Presigned URL ìš”ì²­
                console.log('1. Presigned URL ìš”ì²­ ì¤‘...');
                const { data, error } = await supabase.functions.invoke('get-presigned-url', {
                    body: {
                        fileName: file.name,
                        userId: '5d1e6c3b-7202-4dd8-9a67-d1ff0363f2f1',
                        contentType: file.type,
                        fileType: 'business_registration'
                    }
                });

                if (error) throw error;
                console.log('âœ… Presigned URL ë°›ìŒ:', data);

                // 2. íŒŒì¼ì„ ArrayBufferë¡œ ì½ê¸°
                const arrayBuffer = await file.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);

                // 3. Presigned URLë¡œ íŒŒì¼ ì—…ë¡œë“œ
                console.log('2. íŒŒì¼ ì—…ë¡œë“œ ì¤‘...');
                const uploadResponse = await fetch(data.presignedUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': file.type,
                        'x-amz-content-sha256': 'UNSIGNED-PAYLOAD',
                    },
                    body: uint8Array
                });

                console.log('ì—…ë¡œë“œ ì‘ë‹µ:', uploadResponse.status, uploadResponse);

                if (!uploadResponse.ok) {
                    throw new Error(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${uploadResponse.status}`);
                }

                // 4. ì—…ë¡œë“œëœ íŒŒì¼ URL í‘œì‹œ
                const publicUrl = data.publicUrl;
                
                result.className = 'success';
                result.innerHTML = `
                    <h3>âœ… ì—…ë¡œë“œ ì„±ê³µ!</h3>
                    <p><strong>íŒŒì¼:</strong> ${file.name}</p>
                    <p><strong>í¬ê¸°:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                    <p><strong>URL:</strong> <a href="${publicUrl}" target="_blank">${publicUrl}</a></p>
                    ${file.type.startsWith('image/') ? `<img src="${publicUrl}" style="max-width: 100%; margin-top: 10px; border: 1px solid #ccc;">` : ''}
                `;
                result.style.display = 'block';

            } catch (error) {
                console.error('âŒ ì—ëŸ¬:', error);
                result.className = 'error';
                result.innerHTML = `
                    <h3>âŒ ì—…ë¡œë“œ ì‹¤íŒ¨</h3>
                    <p><strong>ì—ëŸ¬:</strong> ${error.message}</p>
                    <pre>${error.stack || JSON.stringify(error, null, 2)}</pre>
                `;
                result.style.display = 'block';
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'ì—…ë¡œë“œ';
            }
        };
    </script>
</body>
</html>

